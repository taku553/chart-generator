# Chart Generator プログラムロジックの流れ

このドキュメントでは、Chart Generator ウェブアプリケーションがどのように動作し、複雑な統計データからグラフを生成するかの内部的なロジックを平易な言葉で説明します。

---

## 目次

1. [アプリケーション全体の構造](#1-アプリケーション全体の構造)
2. [ファイル処理とデータ解析](#2-ファイル処理とデータ解析)
3. [データ変換と整形](#3-データ変換と整形)
4. [ユーザーインターフェースコンポーネント](#4-ユーザーインターフェースコンポーネント)
5. [単位とスケールの処理](#5-単位とスケールの処理)
6. [グラフの描画と表示](#6-グラフの描画と表示)
7. [デザインとアニメーション](#7-デザインとアニメーション)

---

## 1. アプリケーション全体の構造

### `App.jsx` - アプリケーションの司令塔

`App.jsx`は、アプリケーション全体を統括する「司令塔」です。以下の重要な役割を担っています：

#### 主な機能

**状態管理**
- 現在どの画面を表示しているか（ファイルアップロード画面 or グラフ表示画面）
- どの種類のグラフを表示しているか（棒グラフ、折れ線グラフ、円グラフ）
- アップロードされたファイルの情報
- グラフの再設定モードかどうか

**画面の切り替え**
- データがない場合：`FileUpload`コンポーネントを表示
- データがある場合：`ChartDisplay`コンポーネントを表示
- ユーザーの操作に応じて適切な画面に切り替える

**データの橋渡し**
- `FileUpload`からグラフ用のデータを受け取る
- 受け取ったデータを`ChartDisplay`に渡す
- ファイル情報を保持して、再設定時に再利用できるようにする

**リセット機能**
- 確認ダイアログを表示してから、すべての設定をリセット
- ユーザーが最初からやり直せるようにする

---

## 2. ファイル処理とデータ解析

### `dataUtils.js` - データ処理の道具箱

このファイルには、ファイルを読み込んでデータを扱いやすい形に変換する機能が集まっています。

#### 主な機能

**1. ファイルの読み込み (`parseFile`)**

**CSVファイルの処理**
- 複数のエンコーディング（UTF-8、Shift_JIS、EUC-JP）を自動判別
- 文字化けを防ぐため、適切なエンコーディングで読み込む
- PapaParse ライブラリを使用して、CSVを配列形式に変換

**Excelファイルの処理**
- xlsx ライブラリを使用して、Excelファイルを読み込む
- 複数のシートがある場合、すべてのシート名を取得
- 指定されたシート、または最初のシートのデータを抽出

**2. 数値データの解析 (`parseNumericValue`)**
- 文字列として保存されている数値を、実際の数値型に変換
- カンマ区切りの数値（例：1,000,000）を正しく認識
- 三角形記号（△）をマイナス記号として処理（統計表でよく使われる表記）

**3. データ型の推定 (`inferDataType`)**
- 列のデータを分析して、数値データかカテゴリデータかを自動判別
- サンプルデータの70%以上が数値なら「数値型」と判定
- グラフの種類や軸の扱いを決めるのに使用

**4. グラフ用データへの変換 (`transformDataForChart`)**
- ユーザーが選択したX軸・Y軸の列を抽出
- 各データポイントを {x: 値, y: 値, label: ラベル} の形式に変換
- Chart.js が理解できる形式にデータを整形

**5. 円グラフ用の集計 (`aggregateDataForPieChart`)**
- 同じラベルのデータを合計して集計
- 円グラフに適したデータ構造に変換

---

## 3. データ変換と整形

### `dataTransform.js` - 複雑な統計表を扱う特殊ツール

このファイルには、複雑なレイアウトの統計表を処理するための高度な機能が集まっています。

#### 主な機能

**1. データの転置 (`transposeData`)**
- データの行と列を入れ替える（90度回転させる）
- 横向きのデータを縦向きに、またはその逆に変換
- ユーザーが選択したデータの向きに合わせて調整

**2. データ領域の抽出 (`extractDataRange`)**
- 元の大きな表から、指定された範囲だけを切り出す
- 開始行、終了行、開始列、終了列を指定して範囲を決定
- 統計表の一部分だけを使いたい場合に活用

**3. 複数行ヘッダーの結合 (`mergeHeaderRows`)**
- 複数行にまたがる列見出しを1つに結合
- 例：1行目に「売上」、2行目に「2023年」→ 「売上 2023年」
- 空のセルは無視して、意味のある部分だけを連結

**4. 複数列データ名の結合 (`mergeDataLabelColumns`)**
- 横方向に並んだ複数のデータ名を1つの列に統合
- 例：「2020年」「2021年」「2022年」→ 1つの「年度」列にまとめる
- データを縦長の形式に変換して扱いやすくする

**5. ヘッダーとデータの分離 (`extractHeadersAndDataRows`)**
- 指定された範囲からヘッダー行とデータ行を分離
- 複数行のヘッダーを結合して、1つのヘッダー配列を生成
- データ行の列数をヘッダーの列数に合わせて正規化

**6. 別領域の結合 (`combineHeaderAndDataRanges`)**
- データ領域とは別の場所にあるヘッダーを結合
- 例：表の上部にある総合的な項目名と、本体のデータを組み合わせる
- 複雑なレイアウトの統計表に対応

---

## 4. ユーザーインターフェースコンポーネント

### `FileUpload.jsx` - データ設定の案内役

ファイルアップロードから軸の設定までのすべての手順を管理する、最も重要なコンポーネントです。

#### 主な役割と状態管理

**多段階のステップ管理**

このコンポーネントは、以下の11段階のステップを順番に案内します：

1. ファイルのアップロード
2. シートの選択（Excelの場合）
3. データ領域の選択
4. 列ヘッダー位置の確認
5. データの向き確認
6. ヘッダー行範囲の選択
7. データ名列の選択（オプション）
8. 軸の設定
9. 単位とスケールの設定
10. グラフタイトルの設定
11. グラフの生成

**状態の連携**

各ステップで設定された情報は、次のステップで活用されます：
- データ領域の選択 → 向きの確認時に使用
- ヘッダー範囲の選択 → 軸選択時の項目リストに使用
- データ名の結合 → 新しい列として軸選択に追加

**柔軟な操作**

- 「前に戻る」ボタンで前のステップに戻れる
- 各ステップで「スキップ」や「キャンセル」も可能
- 再設定モードでは、前回の設定を復元

### その他のUIコンポーネント

**`SheetSelector.jsx` - シート選択**
- Excelファイルの各シートをプレビュー表示
- ユーザーがシートを選んで確定

**`DataRangeSelector.jsx` - 範囲選択**
- スプレッドシートのような表形式でデータを表示
- クリックで開始位置と終了位置を選択
- 選択範囲を視覚的にハイライト表示

**`SeparateHeaderSelector.jsx` - 別領域ヘッダー選択**
- データとは別の場所にあるヘッダーの指定
- 「含まれている」か「別の場所」かを選択

**`DataOrientationSelector.jsx` - データの向き確認**
- 2つのプレビュー（そのまま / 回転）を並べて表示
- ユーザーが正しい向きを選択

**`HeaderRangeSelector.jsx` - ヘッダー行範囲選択**
- 複数行にまたがるヘッダーに対応
- 行範囲を指定してヘッダーとして確定

**`DataLabelRangeSelector.jsx` - データ名列選択**
- 横方向のデータ名を縦方向に変換
- 新しい列名を指定可能

**`ChartTitleSettings.jsx` - タイトル設定**
- グラフのタイトルを入力
- デフォルトでY軸の項目名が設定される

---

## 5. 単位とスケールの処理

### `unitUtils.js` - 単位変換の専門家

グラフの軸に表示する単位やデータの倍率を管理する機能が集まっています。

#### 主な機能

**1. 単位のプリセット (`UNIT_PRESETS`)**

よく使われる単位があらかじめ定義されています：
- 通貨：円、ドル、ユーロ
- 重量：kg、t、g
- 数量：人、個、件
- 割合：%

**2. スケールのプリセット (`SCALE_PRESETS`)**

データを読みやすくするための基準値：
- そのまま（1倍）
- 千単位（1,000倍）
- 万単位（10,000倍）
- 百万単位（1,000,000倍）
- 億単位（100,000,000倍）など

**3. 値のフォーマット (`formatValueWithUnit`)**
- 数値に単位を付加（例：「1000円」）
- 千の位区切りを追加（例：「1,000,000」）
- 小数点以下の桁数を調整
- スケールラベルと単位を組み合わせ（例：「百万円」）

**4. 軸ラベルの生成 (`generateAxisLabel`)**
- 列名と単位を組み合わせて軸ラベルを作成
- 例：「売上高」→「売上高 (百万円)」

### `UnitSettings.jsx` - 単位設定の操作画面

ユーザーが単位とスケールを設定するためのインターフェースです。

#### 主な機能

- X軸とY軸それぞれに対して単位を選択
- スケール（基準値）を選択
- プレビューでフォーマット結果を確認
- 設定内容を次のステップに引き継ぐ

---

## 6. グラフの描画と表示

### `ChartDisplay.jsx` - グラフの演出家

データを受け取って、美しいグラフとして表示するコンポーネントです。

#### 主な機能

**1. グラフデータの準備 (`prepareChartData`)**

Chart.jsが理解できる形式にデータを変換：
- 棒グラフ・折れ線グラフ：labels と values の配列を作成
- 円グラフ：集計データを作成し、色の配列も設定

**2. グラフオプションの設定 (`getChartOptions`)**

グラフの見た目と動作を細かく設定：
- タイトルの表示
- 軸のラベルと単位
- ツールチップ（マウスオーバー時の表示）のフォーマット
- 色とスタイル（モノクロ基調）
- アニメーション効果

**3. グラフの種類切り替え**
- ボタンクリックで棒グラフ、折れ線グラフ、円グラフを切り替え
- データは同じで、表示形式だけを変更

**4. データサマリーの計算と表示**
- データ数、最大値、最小値、平均値を自動計算
- 単位設定を適用してフォーマット表示

**5. グラフのダウンロード (`handleDownload`)**
- Chart.jsのcanvas要素をPNG画像に変換
- ブラウザのダウンロード機能で保存

**6. 操作ボタン**
- ホームに戻る：すべてをリセットして最初に戻る
- 条件を変えて再生成：同じファイルで設定を変更
- グラフをダウンロード：現在のグラフを保存

---

## 7. デザインとアニメーション

### `App.css` - 視覚体験の設計図

ウェブページ全体の見た目と動きを定義しています。

#### デザインの特徴

**ミニマルデザイン**
- モノクロを基調としたシンプルで洗練されたデザイン
- 白、黒、グレーのグラデーションで統一感を演出
- 余計な装飾を排除して、データとグラフに集中

**グラスモーフィズム**
- カードやボタンに半透明のガラスのような効果
- 背景のぼかし効果（backdrop-blur）
- 微妙な影とボーダーで奥行きを表現

**アニメーション効果**
- フェードイン：要素がゆっくり現れる
- スライドイン：要素が横や下から滑り込む
- バウンス：軽く跳ねるような動き
- シマー：光沢が流れるような効果
- リップル：波紋のような広がり

これらのアニメーションは、ユーザーの操作に対するフィードバックとして機能し、直感的で心地よい体験を提供します。

---

## プログラムの実行フロー

### 全体の流れ

```
1. アプリ起動 (App.jsx)
   ↓
2. ファイルアップロード (FileUpload.jsx)
   ↓
3. ファイル解析 (dataUtils.js - parseFile)
   ↓
4. シート選択 (SheetSelector.jsx)
   ↓
5. データ領域選択 (DataRangeSelector.jsx)
   ↓
6. データ抽出 (dataTransform.js - extractDataRange)
   ↓
7. ヘッダー位置指定 (SeparateHeaderSelector.jsx)
   ↓
8. データ向き確認 (DataOrientationSelector.jsx)
   ↓
9. データ転置（必要な場合） (dataTransform.js - transposeData)
   ↓
10. ヘッダー範囲選択 (HeaderRangeSelector.jsx)
   ↓
11. ヘッダー結合 (dataTransform.js - mergeHeaderRows)
   ↓
12. データ名列選択 (DataLabelRangeSelector.jsx)
   ↓
13. データ名結合（必要な場合） (dataTransform.js - mergeDataLabelColumns)
   ↓
14. 軸選択 (FileUpload.jsx)
   ↓
15. 単位設定 (UnitSettings.jsx + unitUtils.js)
   ↓
16. タイトル設定 (ChartTitleSettings.jsx)
   ↓
17. グラフデータ変換 (dataUtils.js - transformDataForChart)
   ↓
18. グラフ表示 (ChartDisplay.jsx + Chart.js)
   ↓
19. グラフ操作・ダウンロード
```

### ファイル間の連携

**データの流れ**
1. `App.jsx` が全体を統括
2. `FileUpload.jsx` が各UIコンポーネントを呼び出し
3. UIコンポーネントが `dataTransform.js` の関数を使ってデータを加工
4. 加工されたデータが次のUIコンポーネントに渡される
5. 最終的に `dataUtils.js` でグラフ用データに変換
6. `ChartDisplay.jsx` が Chart.js でグラフを描画

**状態の管理**
- 各コンポーネントは独自の状態（state）を持つ
- 親コンポーネント（App.jsx や FileUpload.jsx）がコールバック関数で子の状態を受け取る
- 受け取った状態を保持して、必要に応じて他のコンポーネントに渡す

---

## まとめ

Chart Generatorは、以下の要素が緊密に連携することで、複雑な統計データから美しいグラフを生成します：

- **司令塔（App.jsx）**: 全体を統括し、画面を切り替える
- **案内役（FileUpload.jsx）**: ユーザーを段階的に導く
- **データ処理（dataUtils.js, dataTransform.js）**: データを読み込み、加工する
- **単位処理（unitUtils.js）**: 数値を読みやすく表示する
- **演出家（ChartDisplay.jsx）**: グラフを美しく描画する
- **デザイン（App.css）**: 統一感のある見た目と滑らかな動きを提供する

これらが協力することで、誰でも簡単に、プロフェッショナルなグラフを作成できるアプリケーションが実現されています。
